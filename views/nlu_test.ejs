<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Doğal Dille Sorgu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --brand:#3b82f6; }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; background:#f6f7fb; color:#0f172a; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    h1 { margin:0 0 16px; font-weight:800; letter-spacing:.2px; }
    .bar { display:flex; gap:12px; margin:8px 0 20px; }
    input[type="text"]{ flex:1; padding:12px 14px; font-size:16px; border:1.5px solid #cbd5e1; border-radius:10px; outline:none; }
    input[type="text"]:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    button{ padding:12px 18px; background:var(--brand); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .card{ background:var(--bg); color:var(--text); padding:16px; border-radius:14px; margin:12px 0 22px; box-shadow: 0 6px 18px rgba(2,8,23,.1); }
    .title{ margin:4px 0 10px; font-weight:800; }
    pre{ margin:0; white-space:pre-wrap; word-break:break-word; font-size:14px; line-height:1.35; }
    .muted{ color:var(--muted); font-size:13px; }
    .row{ display:flex; gap:18px; flex-wrap:wrap; }
    .row .half{ flex:1 1 520px; }
    .hint{ font-size:13px; color:#334155; margin-top:-6px; }
  </style>
</head>
<body>
  <h1>Doğal Dille Sorgu</h1>

  <form id="f" class="bar">
    <input id="q" type="text" placeholder="Örn: 2025 yılı market rakı ciro" autocomplete="off" />
    <button id="send" type="submit">Gönder</button>
  </form>
  <div class="hint">İpuçları: “2024 market rakı litre”, “2025 toptan viski ciro”, “2025 yılında ne kadar whisky satıldı”</div>

  <div class="row">
    <div class="half">
      <div class="title">1) NLU Çıktısı</div>
      <div class="card"><pre id="out">{ }</pre></div>
    </div>
    <div class="half">
      <div class="title">2) Aksiyon Sonucu</div>
      <div class="card"><pre id="out2">{ }</pre></div>
    </div>
  </div>

  <script>
  (function () {
    const f = document.getElementById('f');
    const q = document.getElementById('q');
    const out = document.getElementById('out');
    const out2 = document.getElementById('out2');
    const btn = document.getElementById('send');

    function showJSON(el, obj) {
      el.textContent = JSON.stringify(obj, null, 2);
    }
    function errJSON(message, detail) {
      return { ok: false, error: message, detail: detail || null };
    }

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (q.value || '').trim();
      if (!text) {
        showJSON(out, errJSON('text boş'));
        showJSON(out2, {});
        return;
      }

      btn.disabled = true;
      showJSON(out, { info: 'NLU işleniyor...' });
      showJSON(out2, { info: 'Aksiyon bekleniyor...' });

      try {
        // 1) NLU
        const nlu = await fetch('/nlu/parse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        }).then(r => r.json()).catch(e => errJSON('nlu-parse-istek-hatası', String(e)));

        showJSON(out, nlu);

        // 2) Action — her zaman ham metni de gönder (KRİTİK)
        const body = {
          intent: (nlu && nlu.intent) ? nlu.intent : 'rapor.satis_hacmi_litre',
          slots: (nlu && nlu.slots) ? nlu.slots : {},
          text // 🔴 ham metin
        };

        const act = await fetch('/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        }).then(r => r.json()).catch(e => errJSON('action-istek-hatası', String(e)));

        showJSON(out2, act);
      } catch (e) {
        showJSON(out, errJSON('beklenmeyen-hata', String(e)));
        showJSON(out2, {});
      } finally {
        btn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>
