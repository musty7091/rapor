<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<style>
    @media print {
        @page {
            size: A4 landscape;
        }
    }
    .kategori-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .kategori-row td {
        padding-top: 15px !important;
        padding-bottom: 15px !important;
        color: var(--secondary-color);
        font-size: 1.1rem; /* Kategori adını büyüt */
    }
    .grup-row {
        background-color: #fff;
    }
    .grup-row td:first-child {
        padding-left: 40px !important; /* Ürün grubu için girinti */
        font-weight: bold;
    }
    .ay-row td:first-child {
        padding-left: 80px !important; /* Ay için girinti */
        font-size: 0.85rem;
    }
    table th {
        white-space: normal !important;
    }
</style>

<main class="main-content">
    <h1>
        <i class="fa-solid fa-tags"></i> <%= sayfaBasligi %>
        <button onclick="window.print()" class="print-button">
            <i class="fa-solid fa-file-pdf"></i> PDF Olarak Kaydet
        </button>
    </h1>
    <p style="margin-top: -1.2rem; margin-bottom: 1.5rem; color: #666;">
        Seçilen tedarikçinin 2024 ve 2025 yılı Market (Perakende) satışlarını kategori, ürün grubu ve ay bazında karşılaştırır.
    </p>

    <div class="print-summary">
        <h4>Filtre Özeti</h4>
        <% if (filtreler.tedarikci) { %><p><strong>Tedarikçi:</strong> <%= filtreler.tedarikci %></p><% } %>
        <% if (filtreler.metrik) { %><p><strong>Metrik:</strong> <%= filtreler.metrik.charAt(0).toUpperCase() + filtreler.metrik.slice(1) %></p><% } %>
        <p><strong>Satış Tipi:</strong> Market Satış (101, 102)</p>
        <p><strong>Yıl Karşılaştırması:</strong> 2024 vs 2025</p>
    </div>

    <form method="GET" class="filter-form">
        <div class="form-group" style="flex-grow: 2;">
            <label for="tedarikci">Tedarikçi</label>
            <select name="tedarikci" id="tedarikci" required>
                <option value="">Lütfen bir tedarikçi seçin...</option>
                <% if (tedarikciler) { tedarikciler.forEach(t => { %>
                    <option value="<%= t.TEDARIKCI %>" <%= (filtreler.tedarikci === t.TEDARIKCI) ? 'selected' : '' %>><%= t.TEDARIKCI %></option>
                <% }) } %>
            </select>
        </div>
        
        <div class="form-group">
            <label for="metrik">Analiz Metriği</label>
            <select name="metrik" id="metrik">
                <option value="tutar" <%= (filtreler.metrik === 'tutar') ? 'selected' : '' %>>Tutar</option>
                <option value="adet" <%= (filtreler.metrik === 'adet') ? 'selected' : '' %>>Adet</option>
                <option value="litre" <%= (filtreler.metrik === 'litre') ? 'selected' : '' %>>Litre</option>
            </select>
        </div>

        <div class="form-actions">
            <button type="submit">Analiz Et</button>
            <a href="/tedarikci-kategori-kiyaslama" class="reset-button">Sıfırla</a>
        </div>
    </form>

    <% if (sonuclar && sonuclar.length > 0) { %>
        <% 
            let birimText = 'TL';
            if (filtreler.metrik === 'litre') birimText = 'Litre';
            if (filtreler.metrik === 'adet') birimText = 'Adet';

            const formatNumber = (num) => {
                if (!num) num = 0; // Null veya undefined gelirse 0 yap
                if (filtreler.metrik === 'tutar') {
                    return num.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                }
                const birimSuffix = filtreler.metrik === 'litre' ? ' L' : '';
                return num.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) + birimSuffix;
            };
        %>
        <table>
            <thead>
                <tr>
                    <th>Kategori / Ürün Grubu / Ay</th>
                    <th>2024 Net <%= birimText %></th>
                    <th>2025 Net <%= birimText %></th>
                    <th>Büyüme %</th>
                </tr>
            </thead>
            <tbody>
                <% sonuclar.forEach(kategori => { %>
                    <% 
                        let kategoriDegisim = 0;
                        if (kategori.Toplam2024 > 0) {
                            kategoriDegisim = ((kategori.Toplam2025 - kategori.Toplam2024) / kategori.Toplam2024) * 100;
                        } else if (kategori.Toplam2025 > 0) {
                            kategoriDegisim = 100;
                        }
                    %>
                    <tr class="kategori-row">
                        <td><i class="fa-solid fa-folder-open"></i> <%= kategori.KATEGORI %></td>
                        <td class="sayisal"><%= formatNumber(kategori.Toplam2024) %></td>
                        <td class="sayisal"><%= formatNumber(kategori.Toplam2025) %></td>
                        <td class="sayisal <%= kategoriDegisim >= 0 ? 'karlilik-pozitif' : 'karlilik-negatif' %>">
                            <%= kategoriDegisim.toFixed(2) %>%
                        </td>
                    </tr>
                    <% kategori.urunGruplari.forEach(grup => { %>
                        <% 
                            let grupDegisim = 0;
                            if (grup.Toplam2024 > 0) {
                                grupDegisim = ((grup.Toplam2025 - grup.Toplam2024) / grup.Toplam2024) * 100;
                            } else if (grup.Toplam2025 > 0) {
                                grupDegisim = 100;
                            }
                        %>
                        <tr class="grup-row">
                            <td><i class="fa-solid fa-folder"></i> <%= grup.URUN_GRUBU %></td>
                            <td class="sayisal"><%= formatNumber(grup.Toplam2024) %></td>
                            <td class="sayisal"><%= formatNumber(grup.Toplam2025) %></td>
                            <td class="sayisal <%= grupDegisim >= 0 ? 'karlilik-pozitif' : 'karlilik-negatif' %>">
                                <%= grupDegisim.toFixed(2) %>%
                            </td>
                        </tr>
                        <% grup.aylikData.forEach(ay => { %>
                            <% if(ay.Metrik2024 > 0 || ay.Metrik2025 > 0) { // Sadece veri olan ayları göster %>
                                <%
                                    let ayDegisim = 0;
                                    if (ay.Metrik2024 > 0) ayDegisim = ((ay.Metrik2025 - ay.Metrik2024) / ay.Metrik2024) * 100;
                                    else if (ay.Metrik2025 > 0) ayDegisim = 100;
                                %>
                                <tr class="ay-row">
                                    <td><%= ay.ay %></td>
                                    <td class="sayisal"><%= formatNumber(ay.Metrik2024) %></td>
                                    <td class="sayisal"><%= formatNumber(ay.Metrik2025) %></td>
                                    <td class="sayisal <%= ayDegisim >= 0 ? 'karlilik-pozitif' : 'karlilik-negatif' %>">
                                        <%= ayDegisim.toFixed(2) %>%
                                    </td>
                                </tr>
                            <% } %>
                        <% }) %>
                    <% }) %>
                <% }) %>
            </tbody>
        </table>
    <% } else if (filtreler.tedarikci) { %>
        <div class="info-box" style="background: #fff; padding: 2rem; border-radius: 8px; text-align: center;">
            <p>Seçilen tedarikçi için "Market Satış" verisi bulunamadı.</p>
        </div>
    <% } %>
</main>

<%- include('partials/footer') %>