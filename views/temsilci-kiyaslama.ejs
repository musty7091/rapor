<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<style>
    .comparison-container { display: flex; gap: 2rem; margin-top: 2rem; flex-wrap: wrap; }
    .kpi-container { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .comparison-panel { flex: 1; min-width: 350px; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; }
    .comparison-panel h2 { margin-bottom: 1.5rem; text-align: center; color: var(--secondary-color); }
    .kpi-card { border: none; border-left: 5px solid transparent; padding: 1rem; }
</style>

<main class="main-content">
    <h1><i class="fa-solid fa-scale-balanced"></i> <%= sayfaBasligi %></h1>

    <form action="/temsilci-kiyaslama" method="GET" class="filter-form">
        <div class="form-group">
            <label for="temsilci1">1. Temsilci</label>
            <select name="temsilci1" id="temsilci1">
                <option value="">Seçiniz...</option>
                <% temsilciler.forEach(t => { %>
                    <option value="<%= t.SATISTEMSILCI %>" <%= (filtreler.temsilci1 === t.SATISTEMSILCI) ? 'selected' : '' %>><%= t.SATISTEMSILCI %></option>
                <% }) %>
            </select>
        </div>
        <div class="form-group">
            <label for="temsilci2">2. Temsilci</label>
            <select name="temsilci2" id="temsilci2">
                <option value="">Seçiniz...</option>
                <% temsilciler.forEach(t => { %>
                    <option value="<%= t.SATISTEMSILCI %>" <%= (filtreler.temsilci2 === t.SATISTEMSILCI) ? 'selected' : '' %>><%= t.SATISTEMSILCI %></option>
                <% }) %>
            </select>
        </div>
        
        <div class="form-group">
            <label for="zamanAraligi">Pratik Tarih Aralığı</label>
            <select name="zamanAraligi" id="zamanAraligi">
                <option value="manuel" <%= (!filtreler.zamanAraligi || filtreler.zamanAraligi === 'manuel') ? 'selected' : '' %>>Manuel Seçim</option>
                <option value="bu_ay" <%= (filtreler.zamanAraligi === 'bu_ay') ? 'selected' : '' %>>Bu Ay</option>
                <option value="gecen_ay" <%= (filtreler.zamanAraligi === 'gecen_ay') ? 'selected' : '' %>>Geçen Ay</option>
                <option value="bu_yil" <%= (filtreler.zamanAraligi === 'bu_yil') ? 'selected' : '' %>>Bu Yıl</option>
            </select>
        </div>

        <div class="form-group">
            <label for="baslangicTarihi">Başlangıç Tarihi</label>
            <input type="date" id="baslangicTarihi" name="baslangicTarihi" value="<%= filtreler.baslangicTarihi || '' %>">
        </div>
        <div class="form-group">
            <label for="bitisTarihi">Bitiş Tarihi</label>
            <input type="date" id="bitisTarihi" name="bitisTarihi" value="<%= filtreler.bitisTarihi || '' %>">
        </div>

        <div class="form-group">
            <label for="kategori">Kategori</label>
            <select name="kategori" id="kategori">
                <option value="">Tümü</option>
                <% if (kategoriler) { kategoriler.forEach(k => { %>
                    <option value="<%= k.KATEGORI %>" <%= (filtreler.kategori === k.KATEGORI) ? 'selected' : '' %>><%= k.KATEGORI %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-group">
            <label for="tedarikci">Tedarikçi</label>
            <select name="tedarikci" id="tedarikci">
                <option value="">Tümü</option>
                <% if (tedarikciler) { tedarikciler.forEach(t => { %>
                    <option value="<%= t.TEDARIKCI %>" <%= (filtreler.tedarikci === t.TEDARIKCI) ? 'selected' : '' %>><%= t.TEDARIKCI %></option>
                <% }) } %>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="submit">Kıyasla</button>
            <a href="/temsilci-kiyaslama" class="reset-button">Sıfırla</a>
        </div>
    </form>

    <% 
        const metrics = ['ToplamCiro', 'ToplamKar', 'ToplamMiktar', 'ToplamLitre', 'MusteriSayisi'];
        const classes = { sonuc1: {}, sonuc2: {} };
        let panelClass1 = '', panelClass2 = '';
        if (sonuc1 && sonuc2) {
            if (sonuc1.ToplamCiro > sonuc2.ToplamCiro) panelClass1 = 'winner-panel';
            else if (sonuc2.ToplamCiro > sonuc1.ToplamCiro) panelClass2 = 'winner-panel';
            metrics.forEach(metric => {
                if (sonuc1[metric] > sonuc2[metric]) {
                    classes.sonuc1[metric] = 'winner';
                    classes.sonuc2[metric] = 'loser';
                } else if (sonuc2[metric] > sonuc1[metric]) {
                    classes.sonuc2[metric] = 'winner';
                    classes.sonuc1[metric] = 'loser';
                }
            });
        }
    %>
    <div class="comparison-container">
        <div class="comparison-panel <%= panelClass1 %>">
            <h2><%= filtreler.temsilci1 || '1. Temsilci' %></h2>
            <% if (sonuc1) { %>
                <div class="kpi-container">
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-coins"></i></div><div class="info"><h3>Toplam Ciro</h3><div class="value <%= classes.sonuc1.ToplamCiro || '' %>"><%= sonuc1.ToplamCiro.toLocaleString('tr-TR', {style:'currency', currency:'TRY'}) %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-piggy-bank"></i></div><div class="info"><h3>Toplam Brüt Kâr</h3><div class="value <%= classes.sonuc1.ToplamKar || '' %>"><%= sonuc1.ToplamKar.toLocaleString('tr-TR', {style:'currency', currency:'TRY'}) %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-box-open"></i></div><div class="info"><h3>Toplam Miktar</h3><div class="value <%= classes.sonuc1.ToplamMiktar || '' %>"><%= sonuc1.ToplamMiktar.toLocaleString('tr-TR') %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-bottle-droplet"></i></div><div class="info"><h3>Toplam Litre</h3><div class="value <%= classes.sonuc1.ToplamLitre || '' %>"><%= sonuc1.ToplamLitre.toLocaleString('tr-TR') %> L</div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-users"></i></div><div class="info"><h3>Ulaşılan Müşteri</h3><div class="value <%= classes.sonuc1.MusteriSayisi || '' %>"><%= sonuc1.MusteriSayisi %></div></div></div>
                </div>
            <% } else if (filtreler.temsilci1) { %><p>Bu temsilci için seçilen filtrelerde veri bulunamadı.</p><% } else { %><p>Lütfen kıyaslamak için bir temsilci seçin.</p><% } %>
        </div>
        <div class="comparison-panel <%= panelClass2 %>">
            <h2><%= filtreler.temsilci2 || '2. Temsilci' %></h2>
            <% if (sonuc2) { %>
                <div class="kpi-container">
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-coins"></i></div><div class="info"><h3>Toplam Ciro</h3><div class="value <%= classes.sonuc2.ToplamCiro || '' %>"><%= sonuc2.ToplamCiro.toLocaleString('tr-TR', {style:'currency', currency:'TRY'}) %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-piggy-bank"></i></div><div class="info"><h3>Toplam Brüt Kâr</h3><div class="value <%= classes.sonuc2.ToplamKar || '' %>"><%= sonuc2.ToplamKar.toLocaleString('tr-TR', {style:'currency', currency:'TRY'}) %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-box-open"></i></div><div class="info"><h3>Toplam Miktar</h3><div class="value <%= classes.sonuc2.ToplamMiktar || '' %>"><%= sonuc2.ToplamMiktar.toLocaleString('tr-TR') %></div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-bottle-droplet"></i></div><div class="info"><h3>Toplam Litre</h3><div class="value <%= classes.sonuc2.ToplamLitre || '' %>"><%= sonuc2.ToplamLitre.toLocaleString('tr-TR') %> L</div></div></div>
                    <div class="kpi-card"><div class="icon"><i class="fa-solid fa-users"></i></div><div class="info"><h3>Ulaşılan Müşteri</h3><div class="value <%= classes.sonuc2.MusteriSayisi || '' %>"><%= sonuc2.MusteriSayisi %></div></div></div>
                </div>
            <% } else if (filtreler.temsilci2) { %><p>Bu temsilci için seçilen filtrelerde veri bulunamadı.</p><% } else { %><p>Lütfen kıyaslamak için bir temsilci seçin.</p><% } %>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const zamanAraligiSelect = document.getElementById('zamanAraligi');
        const baslangicInput = document.getElementById('baslangicTarihi');
        const bitisInput = document.getElementById('bitisTarihi');

        function handleDateInputsState() {
            const period = zamanAraligiSelect.value;
            if (period !== 'manuel') {
                baslangicInput.disabled = true;
                bitisInput.disabled = true;
            } else {
                baslangicInput.disabled = false;
                bitisInput.disabled = false;
            }
        }

        zamanAraligiSelect.addEventListener('change', function() {
            const period = this.value;
            if (period !== 'manuel') {
                baslangicInput.value = '';
                bitisInput.value = '';
            }
            handleDateInputsState();
        });
        handleDateInputsState();
    });
</script>

<%- include('partials/footer') %>