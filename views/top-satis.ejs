<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<style>
    @media print {
        @page {
            size: A4 landscape; /* Yatay Sayfa */
        }
    }
</style>

<main class="main-content">
    <h1>
        <i class="fa-solid fa-arrow-up-right-dots"></i> <%= sayfaBasligi %>
        <button onclick="window.print()" class="print-button">
            <i class="fa-solid fa-file-pdf"></i> PDF Olarak Kaydet
        </button>
    </h1>

    <div class="print-summary">
        <h4>Filtre Özeti</h4>
        <% if (filtreler.baslangicTarihi && filtreler.bitisTarihi) { %>
            <p><strong>Tarih Aralığı:</strong> <%= new Date(filtreler.baslangicTarihi).toLocaleDateString('tr-TR') %> - <%= new Date(filtreler.bitisTarihi).toLocaleDateString('tr-TR') %></p>
        <% } %>
        <% if (filtreler.fis_turu) { %><p><strong>Satış Tipi:</strong> <%= filtreler.fis_turu === 'toptan' ? 'Toptan Satış' : 'Market Satış' %></p><% } %>
        <% if (filtreler.tedarikci) { %><p><strong>Tedarikçi:</strong> <%= filtreler.tedarikci %></p><% } %>
        <% if (filtreler.urun_grubu) { %><p><strong>Ürün Grubu:</strong> <%= filtreler.urun_grubu %></p><% } %>
    </div>

    <form method="GET" class="filter-form">
        <div class="form-group">
            <label for="baslangicTarihi">Başlangıç Tarihi</label>
            <input type="date" id="baslangicTarihi" name="baslangicTarihi" value="<%= filtreler.baslangicTarihi || '' %>">
        </div>
        <div class="form-group">
            <label for="bitisTarihi">Bitiş Tarihi</label>
            <input type="date" id="bitisTarihi" name="bitisTarihi" value="<%= filtreler.bitisTarihi || '' %>">
        </div>
        <div class="form-group">
            <label for="fis_turu">Satış Tipi</label>
            <select name="fis_turu" id="fis_turu">
                <option value="">Tümü</option>
                <option value="toptan" <%= (filtreler.fis_turu === 'toptan') ? 'selected' : '' %>>Toptan Satış</option>
                <option value="market" <%= (filtreler.fis_turu === 'market') ? 'selected' : '' %>>Market Satış</option>
            </select>
        </div>
        <div class="form-group">
            <label for="tedarikci">Tedarikçi</label>
            <select name="tedarikci" id="tedarikci">
                <option value="">Tümü</option>
                <% if (tedarikciler) { tedarikciler.forEach(t => { %>
                    <option value="<%= t.TEDARIKCI %>" <%= (filtreler.tedarikci === t.TEDARIKCI) ? 'selected' : '' %>><%= t.TEDARIKCI %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-group">
            <label for="urun_grubu">Ürün Grubu</label>
            <select name="urun_grubu" id="urun_grubu">
                <option value="">Tümü</option>
                <% if (urunGruplari) { urunGruplari.forEach(ug => { %>
                    <option value="<%= ug.URUN_GRUBU %>" <%= (filtreler.urun_grubu === ug.URUN_GRUBU) ? 'selected' : '' %>><%= ug.URUN_GRUBU %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-actions">
            <button type="submit">Analiz Et</button>
        </div>
    </form>

    <% if (sonuclar && sonuclar.length > 0) { %>
        <% 
            const ozetToplamTutar = sonuclar.reduce((sum, s) => sum + s.ToplamTutar, 0);
            const ozetToplamAdet = sonuclar.reduce((sum, s) => sum + s.ToplamAdet, 0);
            const ozetToplamLitre = sonuclar.reduce((sum, s) => sum + s.ToplamLitre, 0);
        %>

        <div class="kpi-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="kpi-card">
                <div class="info">
                    <h3>Listelenen Ürünlerin Toplam Cirosu</h3>
                    <div class="value"><%= ozetToplamTutar.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) %></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="info">
                    <h3>Toplam Adet</h3>
                    <div class="value"><%= ozetToplamAdet.toLocaleString('tr-TR') %></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="info">
                    <h3>Toplam Litre</h3>
                    <div class="value"><%= ozetToplamLitre.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) %> L</div>
                </div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Sıra</th>
                    <th>Ürün Adı</th>
                    <th>Toplam Net Tutar</th>
                    <th>Toplam Net Adet</th>
                    <th>Toplam Net Litre</th>
                </tr>
            </thead>
            <tbody>
                <% sonuclar.forEach((s, index) => { %>
                    <tr>
                        <td><%= index + 1 %></td>
                        <td><%= s.STOK_ADI %></td>
                        <td class="sayisal"><%= s.ToplamTutar.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) %></td>
                        <td class="sayisal"><%= s.ToplamAdet.toLocaleString('tr-TR') %></td>
                        <td class="sayisal"><%= s.ToplamLitre.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) %> L</td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    <% } else { %>
        <div class="info-box" style="background: #fff; padding: 2rem; border-radius: 8px; text-align: center;">
            <p>Lütfen bir filtreleme yaparak analize başlayın veya filtrelere uygun veri bulunamadı.</p>
        </div>
    <% } %>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fisTuruSelect = document.getElementById('fis_turu');
        const tedarikciSelect = document.getElementById('tedarikci');
        const urunGrubuSelect = document.getElementById('urun_grubu');
        const seciliUrunGrubu = '<%= filtreler.urun_grubu || "" %>';

        async function guncelleUrunGruplari() {
            const tedarikci = tedarikciSelect.value;
            const fisTuru = fisTuruSelect.value;
            urunGrubuSelect.disabled = true;
            urunGrubuSelect.innerHTML = '<option value="">Yükleniyor...</option>';
            try {
                const response = await fetch(`/api/urun-gruplari-by-tedarikci?tedarikci=${encodeURIComponent(tedarikci)}&fis_turu=${encodeURIComponent(fisTuru)}`);
                if (!response.ok) throw new Error('Sunucu hatası');
                
                const urunGruplari = await response.json();
                urunGrubuSelect.innerHTML = '<option value="">Tümü</option>';
                
                let seciliGrupHalaListede = false;
                urunGruplari.forEach(ug => {
                    const option = document.createElement('option');
                    option.value = ug.URUN_GRUBU;
                    option.textContent = ug.URUN_GRUBU;
                    if (ug.URUN_GRUBU === seciliUrunGrubu) {
                        option.selected = true;
                        seciliGrupHalaListede = true;
                    }
                    urunGrubuSelect.appendChild(option);
                });
                if(!seciliGrupHalaListede) {
                    urunGrubuSelect.value = "";
                }
            } catch (error) {
                console.error('Ürün Grupları güncellenirken hata oluştu:', error);
                urunGrubuSelect.innerHTML = '<option value="">Gruplar yüklenemedi!</option>';
            } finally {
                urunGrubuSelect.disabled = false;
            }
        }

        tedarikciSelect.addEventListener('change', guncelleUrunGruplari);
        fisTuruSelect.addEventListener('change', guncelleUrunGruplari);
    });
</script>

<%- include('partials/footer') %>