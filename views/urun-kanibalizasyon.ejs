<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<main class="main-content">
    <h1><i class="fa-solid fa-ghost"></i> Ürün Kanibalizasyon Analizi</h1>
    <p style="margin-top: -1.2rem; margin-bottom: 1.5rem; color: #666;">
        Yeni bir ürünün, mevcut bir ürünün satışlarını nasıl etkilediğini (yamyamlık) analiz eder.
    </p>

    <form action="/urun-kanibalizasyon" method="GET" class="filter-form">
        <div class="form-group" style="flex-grow: 1.5;">
            <label for="eski_urun">Pazarını Kaybedebilecek Eski Ürün</label>
            <select name="eski_urun" id="eski_urun" required>
                <option value="">Seçiniz...</option>
                <% if (urunler) { urunler.forEach(u => { %>
                    <option value="<%= u.STOK_ADI %>" <%= (filtreler.eski_urun === u.STOK_ADI) ? 'selected' : '' %>><%= u.STOK_ADI %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-group" style="flex-grow: 1.5;">
            <label for="yeni_urun">Pazara Giren Yeni Ürün</label>
            <select name="yeni_urun" id="yeni_urun" required>
                <option value="">Seçiniz...</option>
                <% if (urunler) { urunler.forEach(u => { %>
                    <option value="<%= u.STOK_ADI %>" <%= (filtreler.yeni_urun === u.STOK_ADI) ? 'selected' : '' %>><%= u.STOK_ADI %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-actions">
            <button type="submit">Karşılaştır</button>
        </div>
    </form>

     <% if (chartData) { %>
        <div class="chart-container" style="background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <canvas id="cannibalizationChart"></canvas>
        </div>
    <% } else if (filtreler.eski_urun) { %>
         <div class="info-box" style="background: #fff; padding: 2rem; border-radius: 8px; text-align: center;">
            <p>Seçilen ürünler için karşılaştırma yapılacak veri bulunamadı.</p>
        </div>
    <% } %>
</main>

<% if (chartData) { %>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('cannibalizationChart').getContext('2d');
        const chartData = <%- JSON.stringify(chartData) %>;
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Eski Ürün Satış Miktarı',
                        data: chartData.eskiUrunData,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                     {
                        label: 'Yeni Ürün Satış Miktarı',
                        data: chartData.yeniUrunData,
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Ürün Satış Trendleri Karşılaştırması' },
                    legend: { position: 'top' },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: chartData.lansmanTarihi,
                                xMax: chartData.lansmanTarihi,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    content: 'Yeni Ürün Lansmanı',
                                    enabled: true,
                                    position: 'start'
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Toplam Satış Miktarı' }
                    }
                }
            }
        });
    });
</script>
<% } %>

<%- include('partials/footer') %>