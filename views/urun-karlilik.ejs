<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<main class="main-content">

    <h1><%= sayfaBasligi %></h1>

    <form action="/urun-karlilik" method="GET" class="filter-form">
        <div class="form-group">
            <label for="zamanAraligi">Pratik Tarih Aralığı</label>
            <select name="zamanAraligi" id="zamanAraligi">
                <option value="manuel" <%= (!filtreler.zamanAraligi || filtreler.zamanAraligi === 'manuel') ? 'selected' : '' %>>Manuel Seçim</option>
                <option value="bu_ay" <%= (filtreler.zamanAraligi === 'bu_ay') ? 'selected' : '' %>>Bu Ay</option>
                <option value="gecen_ay" <%= (filtreler.zamanAraligi === 'gecen_ay') ? 'selected' : '' %>>Geçen Ay</option>
                <option value="bu_yil" <%= (filtreler.zamanAraligi === 'bu_yil') ? 'selected' : '' %>>Bu Yıl</option>
            </select>
        </div>
        <div class="form-group">
            <label for="baslangicTarihi">Başlangıç Tarihi</label>
            <input type="date" id="baslangicTarihi" name="baslangicTarihi" value="<%= filtreler.baslangicTarihi || '' %>">
        </div>
        <div class="form-group">
            <label for="bitisTarihi">Bitiş Tarihi</label>
            <input type="date" id="bitisTarihi" name="bitisTarihi" value="<%= filtreler.bitisTarihi || '' %>">
        </div>
        <div class="form-group">
            <label for="kategori">Kategori</label>
            <select name="kategori" id="kategori">
                <option value="">Tümü</option>
                <% if (kategoriler) { kategoriler.forEach(k => { %>
                    <option value="<%= k.KATEGORI %>" <%= (filtreler.kategori === k.KATEGORI) ? 'selected' : '' %>><%= k.KATEGORI %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-group">
            <label for="urun_grubu">Ürün Grubu</label>
            <select name="urun_grubu" id="urun_grubu">
                <option value="">Tümü</option>
                <% if (urunGruplari) { urunGruplari.forEach(ug => { %>
                    <option value="<%= ug.URUN_GRUBU %>" <%= (filtreler.urun_grubu === ug.URUN_GRUBU) ? 'selected' : '' %>><%= ug.URUN_GRUBU %></option>
                <% }) } %>
            </select>
        </div>
        <div class="form-group">
            <label for="tedarikci">Tedarikçi</label>
            <select name="tedarikci" id="tedarikci">
                <option value="">Tümü</option>
                <% if (tedarikciler) { tedarikciler.forEach(t => { %>
                    <option value="<%= t.TEDARIKCI %>" <%= (filtreler.tedarikci === t.TEDARIKCI) ? 'selected' : '' %>><%= t.TEDARIKCI %></option>
                <% }) } %>
            </select>
        </div>
        <button type="submit">Filtrele</button>
        <a href="/urun-karlilik" class="reset-button">Sıfırla</a>
    </form>

    <table>
        <thead>
            <tr>
                <th>Ürün Adı</th>
                <th>Toplam Ciro</th>
                <th>Toplam Kâr</th>
                <th>Kârlılık Oranı</th>
            </tr>
        </thead>
        <tbody>
             <% if (sonuclar && sonuclar.length > 0) { %>
                <% sonuclar.forEach(s => { %>
                    <tr>
                        <td><%= s.STOK_ADI %></td>
                        <td class="sayisal"><%= s.ToplamCiro.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) %></td>
                        <td class="sayisal"><%= s.ToplamKar.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) %></td>
                        <% const karlilik = s.ToplamCiro > 0 ? (s.ToplamKar / s.ToplamCiro) * 100 : 0; %>
                        <td class="sayisal <%= karlilik >= 0 ? 'karlilik-pozitif' : 'karlilik-negatif' %>"><%= karlilik.toFixed(2) %>%</td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">Filtre kriterlerine uygun veri bulunamadı.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const zamanAraligiSelect = document.getElementById('zamanAraligi');
        const baslangicInput = document.getElementById('baslangicTarihi');
        const bitisInput = document.getElementById('bitisTarihi');

        function updateDateInputsState() {
            const isManual = zamanAraligiSelect.value === 'manuel';
            baslangicInput.disabled = !isManual;
            bitisInput.disabled = !isManual;
        }

        zamanAraligiSelect.addEventListener('change', function() {
            if (this.value !== 'manuel') {
                baslangicInput.value = '';
                bitisInput.value = '';
            }
            updateDateInputsState();
        });
        
        updateDateInputsState();
    });
</script>

<%- include('partials/footer') %>